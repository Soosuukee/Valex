<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="./dist/output.css" rel="stylesheet" />
    <title>Map Viewer</title>
  </head>
  <body
    class="bg-zinc-900 text-white min-h-screen p-8 flex flex-col items-center justify-start overflow-auto"
  >
    <h1 id="mapName" class="text-3xl font-bold mb-6"></h1>

    <div class="w-full max-w-[1000px] relative">
      <img
        id="mapImage"
        src=""
        alt="Map"
        class="w-full h-auto rounded relative z-0"
      />
      <div
        id="calloutContainer"
        class="absolute inset-0 pointer-events-none z-10"
      ></div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const uuid = params.get("uuid");

      if (!uuid) {
        document.body.innerHTML =
          "<p class='text-red-500'>Erreur : aucune carte fournie.</p>";
      } else {
        fetch("https://valorant-api.com/v1/maps")
          .then((res) => res.json())
          .then((data) => {
            const map = data.data.find((m) => m.uuid === uuid);
            if (!map) {
              document.body.innerHTML =
                "<p class='text-red-500'>Erreur : carte non trouvée.</p>";
              return;
            }

            document.getElementById("mapName").textContent = map.displayName;
            const mapImg = document.getElementById("mapImage");
            const calloutContainer =
              document.getElementById("calloutContainer");

            mapImg.src = map.displayIcon;

            mapImg.addEventListener("load", () => {
              if (!Array.isArray(map.callouts) || map.callouts.length === 0) {
                console.warn("Pas de callouts trouvés pour cette carte.");
                return;
              }

              // Étape 1 : récupérer les bornes x/y
              const xs = map.callouts.map((c) => c.location.x);
              const ys = map.callouts.map((c) => c.location.y);
              const minX = Math.min(...xs);
              const maxX = Math.max(...xs);
              const minY = Math.min(...ys);
              const maxY = Math.max(...ys);

              // Étape 2 : convertir les coordonnées en pourcentages
              map.callouts.forEach(({ regionName, location }) => {
                const { x, y } = location;

                const percentX = ((x - minX) / (maxX - minX)) * 100;
                const percentY = 100 - ((y - minY) / (maxY - minY)) * 100;

                console.log(
                  regionName,
                  percentX.toFixed(2),
                  percentY.toFixed(2)
                );

                const div = document.createElement("div");
                div.className =
                  "absolute bg-red-600 text-white text-xs font-bold px-1 py-[1px] rounded transform -translate-x-1/2 -translate-y-1/2";
                div.style.left = `${percentX}%`;
                div.style.top = `${percentY}%`;
                div.textContent = regionName;
                calloutContainer.appendChild(div);
              });
            });
          });
      }
    </script>
  </body>
</html>
